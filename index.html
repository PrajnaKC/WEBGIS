<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üó∫Ô∏è Village Land Plots - Google Maps API</title>
    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />
    <!-- Your custom CSS -->
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <h2>üó∫Ô∏è Village Land Plots - Google Maps API</h2>
    <div id="status-panel" aria-live="polite">
        <div class="status-row"><strong>Mode:</strong> <span id="status-mode">Initializing‚Ä¶</span></div>
        <div class="status-row"><strong>Features:</strong> <span id="status-features">0</span></div>
        <div class="status-row"><strong>Fallback:</strong> <span id="status-fallback">No</span></div>
        <div class="status-row small" id="status-message">Loading‚Ä¶</div>
    </div>
    <div id="map">
        <div style="text-align: center; padding: 50px; color: #666;">
            Loading Google Maps...
        </div>
    </div>

    <!-- Leaflet JavaScript (for hybrid support) -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
        defer
    ></script>
        <!-- App logic (defines initGoogleMap) -->
        <script src="script.js" defer></script>
        <!-- Diagnostic probe: check exposure timing -->
        <script>
            window.__gmProbeTime = Date.now();
            document.addEventListener('DOMContentLoaded', () => {
                console.log('[DIAG] DOMContentLoaded. window.initGoogleMap =', typeof window.initGoogleMap);
            });
            setTimeout(() => {
                console.log('[DIAG] +1500ms after insertion. window.initGoogleMap =', typeof window.initGoogleMap);
            }, 1500);
        </script>
    <!-- Google Maps API (defer only for stable callback) -->
    <script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDciPsvdxOy-OnesSpduDg_g-mojbC-NGI&libraries=geometry,places&callback=initGoogleMap&loading=async">
    </script>
    <!-- Manual safety initializer: if callback not invoked, try to start map explicitly -->
    <script>
        (function(){
            const startTime = Date.now();
            let attempts = 0;
            function tryManualInit(){
                if (window.google && google.maps){
                    if (typeof window.initGoogleMap === 'function') {
                        if (!window.__MANUAL_GMAP_INIT_DONE) {
                            console.warn('[GMAP] Manual init attempt #' + (attempts+1));
                            try { window.initGoogleMap(); window.__MANUAL_GMAP_INIT_DONE = true; } catch(e){ console.error('[GMAP] Manual init failed:', e); }
                        }
                        return; // success or already attempted
                    } else {
                        console.warn('[GMAP] google.maps present but initGoogleMap not defined yet.');
                    }
                } else if (attempts === 0) {
                    console.log('[GMAP] Waiting for google.maps to become available...');
                }
                if (++attempts < 20) { // ~3s (20 * 150ms)
                    setTimeout(tryManualInit, 150);
                } else {
                    const msgEl = document.getElementById('status-message');
                    if (msgEl) msgEl.textContent = 'Google Maps failed. Switching to Leaflet fallback.';
                    console.error('[GMAP] Gave up after ' + (Date.now()-startTime) + 'ms. Initiating Leaflet fallback.');
                    // Try to invoke Leaflet fallback if app code loaded
                    try {
                        if (typeof window.initLeafletFallback === 'function') {
                            window.initLeafletFallback();
                        } else if (typeof window.switchToLeaflet === 'function') {
                            window.switchToLeaflet();
                        } else {
                            console.warn('[GMAP] Leaflet fallback function not exposed globally.');
                        }
                    } catch(e){ console.error('[GMAP] Error invoking Leaflet fallback:', e); }
                    console.info('[GMAP] Troubleshoot Google:');
                    console.info(' 1) Network tab -> filter "maps" -> confirm 200 status');
                    console.info(' 2) Console: check for gm_authFailure / RefererNotAllowedMapError');
                    console.info(' 3) Disable blockers or try Incognito');
                    console.info(' 4) Enable Maps JavaScript API & billing in Google Cloud');
                }
            }
            document.addEventListener('DOMContentLoaded', ()=> setTimeout(tryManualInit, 400));
        })();
    </script>
    
    <script>
        // Fallback error handling
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e.error);
            const mapDiv = document.getElementById('map');
            if (mapDiv && !mapDiv.querySelector('.leaflet-container')) {
                mapDiv.innerHTML = '<p style="text-align: center; padding: 50px; color: red;">Error loading map. Please check console for details.</p>';
            }
        });

                // Recovery: if initGoogleMap not defined after a short delay, re-inject script.js
                setTimeout(() => {
                    if (typeof window.initGoogleMap === 'undefined') {
                        console.warn('[RECOVERY] initGoogleMap still undefined; reinjecting script.js');
                        const s = document.createElement('script');
                        s.src = 'script.js?_reload=' + Date.now();
                        s.onload = () => console.log('[RECOVERY] Reinjected script.js, now initGoogleMap =', typeof window.initGoogleMap);
                        s.onerror = () => console.error('[RECOVERY] Failed to reinject script.js');
                        document.head.appendChild(s);
                    } else {
                        console.log('[RECOVERY] initGoogleMap present, no reinjection needed.');
                    }
                }, 1200);
    </script>
</body>
</html>
